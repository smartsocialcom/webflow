<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
  const url = new URL(window.location.href);
  const searchParams = url.searchParams;
  let orgValue;
  let memberData;
  let orgActive;

  function setCookie(k, v, d) {
    document.cookie = `${encodeURIComponent(k)}=${encodeURIComponent(v)};expires=${(new Date(Date.now() + d * 864e5)).toUTCString()};path=/`;
  }

  function getCookie(k) {
      const cookie = document.cookie.split('; ').find(row => row.startsWith(k + '='));
      return cookie ? decodeURIComponent(cookie.split('=')[1]) : null;
  }
  
  function removeCookie(key) {
    document.cookie = `${encodeURIComponent(key)}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
  }

  function applyOrgData(districtName, schoolBuildings) {
    document.getElementById("district_name").textContent = districtName.includes("free trial") ? districtName : `${districtName} has partnered with Smartsocial.com`;
    document.getElementById("district_name_input").value = districtName;
  }

  function getOrg(orgValue) {
    return new Promise((resolve, reject) => {
      axios.get(`https://xlbh-3re4-5vsp.n7c.xano.io/api:eJ2WWeJh/organizations/short_code/${orgValue}`)
        .then(response => {
          orgData = response.data;
          orgActive = orgData.organization.org_active;
          
          if(orgActive) {
            setCookie("org", orgValue, 400);
            applyOrgData(orgData.organization.district_name);
            resolve(response.data);
            console.log(orgActive+"YES")
          } else {
            console.log(orgActive+"NO");
            orgNotActive();
          }
          console.log(orgData.organization.org_active);
      });
    });
  }

  function getAccess() {
    if (orgValue) {
      document.getElementById("get_access").click();
      document.getElementById("orgInput").value = orgValue;
    }
  }

  function emailInUse() {
    const emailFieldSignup = document.getElementById("email");
    const firstNameFieldSignup = document.getElementById("first_name");
    document.getElementById("login_button_signup").href = `/login?email=${emailFieldSignup.value}`;

    mixpanel.identify(emailFieldSignup.value);
    mixpanel.people.set({
      first_name: firstNameFieldSignup.value,
      email: emailFieldSignup.value,
      org: orgValue,
    });
  }

  function getOrgValue() {
    const cookie = getCookie("org");
    const ms = memberData && memberData.customFields ? memberData.customFields.organization : undefined;
    const parameter = decodeURIComponent(searchParams.get("org")?.split('?')[0] ?? "");
    orgValue = cookie ? cookie : ms ? ms : parameter;
  }

  function orgNotActive(){
    document.getElementById('not_active_banner').classList.remove('hide');
  }

  // On Load
  // url.hash && (window.location.href = url.href.replace('#', ''));
  document.addEventListener('DOMContentLoaded', function() {
    (async () => {
      memberData = (await window.$memberstackDom.getCurrentMember()).data;
      getOrgValue();
      getOrg(orgValue);
      if (!memberData){
        getOrg(orgValue).then(getAccess);
        setTimeout(() => {
			    if (getCookie("org")){
            document.querySelectorAll('[ss-content="hide"]').forEach(el => el.classList.add('hide'));
        	}
      	}, 4000);
        	
      } else {
        axios.post('https://xlbh-3re4-5vsp.n7c.xano.io/api:eJ2WWeJh/log', {
          member_id: memberData.id,
          page_url: window.location.href
        });
      }
      
      document.querySelectorAll(".lang-select").forEach(e => e.onclick = () => setTimeout(() => location.reload(), 500)); // Refresh page on lang switcher click
      document.querySelectorAll('[sms="store_link"]').forEach(link => link.addEventListener('click', () => localStorage.setItem("locat", location.href))); // Store Last Page
      if(orgValue) document.querySelectorAll('a').forEach(link => !link.href.includes('org=') && (link.href += (link.href.includes('?') ? '&' : '?') + 'org=' + orgValue)); // add org to all links 

      // Handle Signup Button Click
      document.getElementById("signup_button").addEventListener("click", function () {
        setTimeout(function () {
          emailInUse();
        }, 500);
        document.getElementById("ms_signup_button").click();
      });

            
      // Trigger Mixpanel Event
      document.querySelectorAll("[mx]").forEach(function (element) {
        element.addEventListener("click", function () {
          var mxValue = element.getAttribute("mx");
          mixpanel.track(mxValue);
        });
      });
    })();
  });
</script>


<!-- ðŸ’™ MEMBERSCRIPT #10 v0.2 ðŸ’™ HIDE ELEMENTS IF CUSTOM FIELD IS BLANK -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get the `_ms-mem` object from the local storage
  const msMem = JSON.parse(localStorage.getItem('_ms-mem'));

  // Get all the elements that have the `ms-code-customfield` attribute
  const elements = document.querySelectorAll('[ms-code-customfield]');

  // Iterate over each element
  elements.forEach(element => {
    // Get the value of the `ms-code-customfield` attribute
    const customField = element.getAttribute('ms-code-customfield');

    // If customField starts with '!', we invert the logic
    if (customField.startsWith('!')) {
      const actualCustomField = customField.slice(1); // remove the '!' from the start

      // If the custom field is empty, remove the element from the DOM
      if (msMem.customFields && msMem.customFields[actualCustomField]) {
        element.parentNode.removeChild(element);
      }
    } else {
      // Check if the user has the corresponding custom field in Memberstack
      if (!msMem.customFields || !msMem.customFields[customField]) {
        // If the custom field is empty, remove the element from the DOM
        element.parentNode.removeChild(element);
      }
    }
  });
});
</script>